(function(e){function r(e){return e}function s(){}function f(e){return Math.floor(e/1e3)}function l(e){var t=e.indexOf("|"),n=e.substring(0,t),r=n.lastIndexOf(","),i=n.lastIndexOf(",",r-1),s=n.lastIndexOf(",",i-1),o=n.substring(s+1,i)*1e3,u=n.substring(r+1)*1e3;return e.substring(t+1).split(",").slice(1).map(function(e){return+e})}function c(e){if(!(e instanceof s))throw new Error("invalid context");this.context=e}function d(e,t){return function(n,r,i,s){e(new Date(+n+t),new Date(+r+t),i,s)}}function v(e,t){c.call(this,e),t=+t;var n=t+"";this.valueOf=function(){return t},this.toString=function(){return n}}function g(e,t){function n(t,n){if(n instanceof c){if(t.context!==n.context)throw new Error("mismatch context")}else n=new v(t.context,n);c.call(this,t.context),this.left=t,this.right=n,this.toString=function(){return t+" "+e+" "+n}}var r=n.prototype=Object.create(c.prototype);return r.valueAt=function(e){return t(this.left.valueAt(e),this.right.valueAt(e))},r.shift=function(e){return new n(this.left.shift(e),this.right.shift(e))},r.on=function(e,t){return arguments.length<2?this.left.on(e):(this.left.on(e,t),this.right.on(e,t),this)},function(e){return new n(this,e)}}function w(e){return e&16777214}function E(e){return(e+1&16777214)-1}function S(e){e.style("position","absolute").style("top",0).style("bottom",0).style("width","1px").style("pointer-events","none")}function x(e){return e+"px"}var t=e.cubism={version:"1.6.0-linear"},n=0;t.option=function(e,n){var r=t.options(e);return r.length?r[0]:n},t.options=function(e,t){var n=location.search.substring(1).split("&"),r=[],i=-1,s=n.length,o;while(++i<s)(o=n[i].split("="))[0]==e&&r.push(decodeURIComponent(o[1]));return r.length||arguments.length<2?r:t},t.context=function(){function v(){var n=Date.now();return o=new Date(Math.floor((n-f-l)/t)*t),i=new Date(o-r*t),a=new Date(Math.floor((n-f)/t)*t),u=new Date(a-r*t),h.domain([0,r*t/1e3]),e}var e=new s,t=1e4,r=1440,i,o,u,a,f=5e3,l=5e3,c=d3.dispatch("prepare","beforechange","change","focus"),h=e.scale=d3.scale.linear().range([0,r*t/1e3]),p,d;return e.start=function(){p&&clearTimeout(p);var n=+a+f-Date.now();return n<l&&(n+=t),p=setTimeout(function s(){a=new Date(Math.floor((Date.now()-f)/t)*t),u=new Date(a-r*t),c.prepare.call(e,u,a),setTimeout(function(){h.domain([i=u,o=a]),c.beforechange.call(e,u,a),c.change.call(e,u,a),c.focus.call(e,d)},l),p=setTimeout(s,t)},n),e},e.stop=function(){return p=clearTimeout(p),e},p=setTimeout(e.start,10),e.step=function(e){return arguments.length?(t=+e,v()):t},e.size=function(e){return arguments.length?(h.range([0,r=+e]),v()):r},e.serverDelay=function(e){return arguments.length?(f=+e,v()):f},e.clientDelay=function(e){return arguments.length?(l=+e,v()):l},e.focus=function(t){return c.focus.call(e,d=t),e},e.on=function(t,n){return arguments.length<2?c.on(t):(c.on(t,n),n!=null&&(/^prepare(\.|$)/.test(t)&&n.call(e,u,a),/^beforechange(\.|$)/.test(t)&&n.call(e,i,o),/^change(\.|$)/.test(t)&&n.call(e,i,o),/^focus(\.|$)/.test(t)&&n.call(e,d)),e)},d3.select(window).on("keydown.context-"+ ++n,function(){switch(!d3.event.metaKey&&d3.event.keyCode){case 37:d==null&&(d=r-1),d>0&&e.focus(--d);break;case 39:d==null&&(d=r-2),d<r-1&&e.focus(++d);break;default:return}d3.event.preventDefault()}),v()};var o=t.context.prototype=s.prototype;o.constant=function(e){return new v(this,+e)},o.cube=function(e){arguments.length||(e="");var t={},n=this;return t.metric=function(t){return n.metric(function(n,r,i,s){d3.json(e+"/1.0/metric"+"?expression="+encodeURIComponent(t)+"&start="+u(n)+"&stop="+u(r)+"&step="+i,function(e){if(!e)return s(new Error("unable to load data"));s(null,e.map(function(e){return e.value}))})},t+="")},t.toString=function(){return e},t};var u=d3.time.format.iso;o.librato=function(e,n){function o(e){var t=avail_rsts[0],n=avail_rsts[avail_rsts.length];if(e>=n)return n;if(e<=t)return t;var r,i,s;for(s=e;s<=n;s++){r=avail_rsts.indexOf(s);if(r>-1){i=avail_rsts[r];break}}var o;for(s=e;s>=t;s--){r=avail_rsts.indexOf(s);if(r>-1){o=avail_rsts[r];break}}return i-e<e-o?i:o}function u(e,t,n){var r=t-e,i=2419200,s=604800,u=172800,a;return r>i?3600:(a=o(n),r>s&&a<900?900:r>u&&a<60?60:a)}var r={},s=this;auth_string="Basic "+btoa(e+":"+n),avail_rsts=[1,60,900,3600];var f=function(e){function r(t,r,i){var s="compose="+e+"&start_time="+t+"&end_time="+r+"&resolution="+u(t,r,i);return n+"?"+s}function s(e,t,n,r){var s=[];for(i=e;i<=t;i+=n){var o=[];while(r.length&&r[0].measure_time<=i)o.push(r.shift().value);var u;o.length?u=o.reduce(function(e,t){return e+t})/o.length:u=s.length?s[s.length-1]:0,s.push(u)}return s}var n="https://metrics-api.librato.com/v1/metrics";return request={},request.fire=function(e,n,i,o){function a(f){d3.json(f).header("X-Requested-With","XMLHttpRequest").header("Authorization",auth_string).header("Librato-User-Agent","cubism/"+t.version).get(function(t,f){if(!t){if(f.measurements.length===0)return;f.measurements[0].series.forEach(function(e){u.push(e)});var l="query"in f&&"next_time"in f.query;if(l)a(r(f.query.next_time,n,i));else{var c=s(e,n,i,u);o(c)}}})}var u=[];a(r(e,n,i))},request};return r.metric=function(e){return s.metric(function(t,n,r,i){f(e).fire(a(t),a(n),a(r),function(e){i(null,e)})},e+="")},r.toString=function(){return"librato"},r};var a=function(e){return Math.floor(e/1e3)};o.graphite=function(e){arguments.length||(e="");var t={},n=this;return t.metric=function(t){var r="sum",i=n.metric(function(n,i,s,o){var u=t;s!==1e4&&(u="summarize("+u+",'"+(s%36e5?s%6e4?s/1e3+"sec":s/6e4+"min":s/36e5+"hour")+"','"+r+"')"),d3.text(e+"/render?format=raw"+"&target="+encodeURIComponent("alias("+u+",'')")+"&from="+f(n-2*s)+"&until="+f(i-1e3),function(e){if(!e)return o(new Error("unable to load data"));o(null,l(e))})},t+="");return i.summarize=function(e){return r=e,i},i},t.find=function(t,n){d3.json(e+"/metrics/find?format=completer"+"&query="+encodeURIComponent(t),function(e){if(!e)return n(new Error("unable to find metrics"));n(null,e.metrics.map(function(e){return e.path}))})},t.toString=function(){return e},t},o.gangliaWeb=function(e){var t="",n="/ganglia2/";arguments.length&&(e.host&&(t=e.host),e.uriPathPrefix&&(n=e.uriPathPrefix,n[0]!="/"&&(n="/"+n),n[n.length-1]!="/"&&(n+="/")));var r={},i=this;return r.metric=function(e){var r=e.clusterName,s=e.metricName,o=e.hostName,u=e.isReport||!1,a=e.titleGenerator||function(e){return"clusterName:"+r+" metricName:"+s+(o?" hostName:"+o:"")},f=e.onChangeCallback,l=u?"g":"m",c=i.metric(function(e,i,u,a){function f(){return"c="+r+"&"+l+"="+s+(o?"&h="+o:"")+"&cs="+e/1e3+"&ce="+i/1e3+"&step="+u/1e3+"&graphlot=1"}d3.json(t+n+"graph.php?"+f(),function(e){if(!e)return a(new Error("Unable to fetch GangliaWeb data"));a(null,e[0].data)})},a(e));return c.toString=function(){return a(e)},f&&c.on("change",f),c},r.toString=function(){return t+n},r};var h=c.prototype;t.metric=c,h.valueAt=function(){return NaN},h.alias=function(e){return this.toString=function(){return e},this},h.extent=function(){var e=0,t=this.context.size(),n,r=Infinity,i=-Infinity;while(++e<t)n=this.valueAt(e),n<r&&(r=n),n>i&&(i=n);return[r,i]},h.on=function(e,t){return arguments.length<2?null:this},h.shift=function(){return this},h.on=function(){return arguments.length<2?null:this},o.metric=function(e,t){function g(t,n){var r=Math.min(f,Math.round((t-o)/a));if(!r||m)return;m=!0,r=Math.min(f,r+p);var s=new Date(n-r*a);e(s,n,a,function(e,t){m=!1;if(e)return console.warn(e);var r=isFinite(o)?Math.round((s-o)/a):0;for(var u=0,f=t.length;u<f;++u)l[u+r]=t[u];h.change.call(i,o,n)})}function y(e,t){isFinite(o)||(o=e),l.splice(0,Math.max(0,Math.min(f,Math.round((e-o)/a)))),o=e,u=t}var r=this,i=new c(r),s=".metric-"+ ++n,o=-Infinity,u,a=r.step(),f=r.size(),l=[],h=d3.dispatch("change"),v=0,m;return i.valueAt=function(e){return l[e]},i.shift=function(t){return r.metric(d(e,+t))},i.on=function(e,t){return arguments.length?(t==null?h.on(e)!=null&&--v==0&&r.on("prepare"+s,null).on("beforechange"+s,null):h.on(e)==null&&++v==1&&r.on("prepare"+s,g).on("beforechange"+s,y),h.on(e,t),t!=null&&/^change(\.|$)/.test(e)&&t.call(r,o,u),i):h.on(e)},arguments.length>1&&(i.toString=function(){return t}),i};var p=6,m=v.prototype=Object.create(c.prototype);m.valueAt=function(){return+this},m.extent=function(){return[+this,+this]},h.add=g("+",function(e,t){return e+t}),h.subtract=g("-",function(e,t){return e-t}),h.multiply=g("*",function(e,t){return e*t}),h.divide=g("/",function(e,t){return e/t}),o.horizon=function(){function d(d){d.on("mousemove.horizon",function(){e.focus(Math.round(d3.mouse(this)[0]))}).on("mouseout.horizon",function(){e.focus(null)}),d.append("canvas").attr("width",s).attr("height",o),d.append("span").attr("class","title").text(l),d.append("span").attr("class","value"),d.each(function(l,d){function k(n,r){S.save();var a=g.extent();C=a.every(isFinite),b!=null&&(a=b);var f=0,l=Math.max(-a[0],a[1]);if(this===e){if(l==T){f=s-p;var c=(n-w)/E;if(c<s){var h=i.getContext("2d");h.clearRect(0,0,s,o),h.drawImage(S.canvas,c,0,s-c,o,0,0,s-c,o),S.clearRect(0,0,s,o),S.drawImage(h.canvas,0,0)}}w=n}u.domain([0,T=l]),S.clearRect(f,0,s-f,o);var d;for(var v=0;v<N;++v){S.fillStyle=y[N+v];var m=(v-N+1)*o;u.range([N*o+m,m]),m=u(0);for(var x=f,k=s,L;x<k;++x){L=g.valueAt(x);if(L<=0){d=!0;continue}if(L===undefined)continue;S.fillRect(x,L=u(L),1,m-L)}}if(d){t==="offset"&&(S.translate(0,o),S.scale(1,-1));for(var v=0;v<N;++v){S.fillStyle=y[N-1-v];var m=(v-N+1)*o;u.range([N*o+m,m]),m=u(0);for(var x=f,k=s,L;x<k;++x){L=g.valueAt(x);if(L>=0)continue;S.fillRect(x,u(-L),1,m-u(-L))}}}S.restore()}function L(e){e==null&&(e=s-1);var t=g.valueAt(e);x.datum(t).text(isNaN(t)?null:c)}var v=this,m=++n,g=typeof a=="function"?a.call(v,l,d):a,y=typeof h=="function"?h.call(v,l,d):h,b=typeof f=="function"?f.call(v,l,d):f,w=-Infinity,E=e.step(),S=d3.select(v).select("canvas"),x=d3.select(v).select(".value"),T,N=y.length>>1,C;S.datum({id:m,metric:g}),S=S.node().getContext("2d"),e.on("change.horizon-"+m,k),e.on("focus.horizon-"+m,L),g.on("change.horizon-"+m,function(e,t){k(e,t),L(),C&&g.on("change.horizon-"+m,r)})})}var e=this,t="offset",i=document.createElement("canvas"),s=i.width=e.size(),o=i.height=30,u=d3.scale.linear().interpolate(d3.interpolateRound),a=r,f=null,l=r,c=d3.format(".2s"),h=["#08519c","#3182bd","#6baed6","#bdd7e7","#bae4b3","#74c476","#31a354","#006d2c"];return d.remove=function(t){function n(t){t.metric.on("change.horizon-"+t.id,null),e.on("change.horizon-"+t.id,null),e.on("focus.horizon-"+t.id,null)}t.on("mousemove.horizon",null).on("mouseout.horizon",null),t.selectAll("canvas").each(n).remove(),t.selectAll(".title,.value").remove()},d.mode=function(e){return arguments.length?(t=e+"",d):t},d.height=function(e){return arguments.length?(i.height=o=+e,d):o},d.metric=function(e){return arguments.length?(a=e,d):a},d.scale=function(e){return arguments.length?(u=e,d):u},d.extent=function(e){return arguments.length?(f=e,d):f},d.title=function(e){return arguments.length?(l=e,d):l},d.format=function(e){return arguments.length?(c=e,d):c},d.colors=function(e){return arguments.length?(h=e,d):h},d},o.comparison=function(){function d(d){d.on("mousemove.comparison",function(){e.focus(Math.round(d3.mouse(this)[0]))}).on("mouseout.comparison",function(){e.focus(null)}),d.append("canvas").attr("width",t).attr("height",i),d.append("span").attr("class","title").text(f),d.append("span").attr("class","value primary"),d.append("span").attr("class","value change"),d.each(function(f,d){function k(n,r){x.save(),x.clearRect(0,0,t,i);var o=g.extent(),u=y.extent(),a=b==null?o:b;s.domain(a).range([i,0]),C=o.concat(u).every(isFinite);var f=n/e.step()&1?E:w;x.fillStyle=h[2];for(var l=0,c=t;l<c;++l){var d=s(g.valueAt(l)),v=s(y.valueAt(l));d<v&&x.fillRect(f(l),d,1,v-d)}x.fillStyle=h[0];for(l=0;l<c;++l){var d=s(g.valueAt(l)),v=s(y.valueAt(l));d>v&&x.fillRect(f(l),v,1,d-v)}x.fillStyle=h[3];for(l=0;l<c;++l){var d=s(g.valueAt(l)),v=s(y.valueAt(l));d<=v&&x.fillRect(f(l),d,1,p)}x.fillStyle=h[1];for(l=0;l<c;++l){var d=s(g.valueAt(l)),v=s(y.valueAt(l));d>v&&x.fillRect(f(l),d-p,1,p)}x.restore()}function L(e){e==null&&(e=t-1);var n=g.valueAt(e),r=y.valueAt(e),i=(n-r)/r;T.datum(n).text(isNaN(n)?null:l),N.datum(i).text(isNaN(i)?null:c).attr("class","value change "+(i>0?"positive":i<0?"negative":""))}function A(e,t){k(e,t),L(),C&&(g.on("change.comparison-"+m,r),y.on("change.comparison-"+m,r))}var v=this,m=++n,g=typeof o=="function"?o.call(v,f,d):o,y=typeof u=="function"?u.call(v,f,d):u,b=typeof a=="function"?a.call(v,f,d):a,S=d3.select(v),x=S.select("canvas"),T=S.select(".value.primary"),N=S.select(".value.change"),C;x.datum({id:m,primary:g,secondary:y}),x=x.node().getContext("2d"),g.on("change.comparison-"+m,A),y.on("change.comparison-"+m,A),e.on("change.comparison-"+m,k),e.on("focus.comparison-"+m,L)})}var e=this,t=e.size(),i=120,s=d3.scale.linear().interpolate(d3.interpolateRound),o=function(e){return e[0]},u=function(e){return e[1]},a=null,f=r,l=y,c=b,h=["#9ecae1","#225b84","#a1d99b","#22723a"],p=1.5;return d.remove=function(t){function n(t){t.primary.on("change.comparison-"+t.id,null),t.secondary.on("change.comparison-"+t.id,null),e.on("change.comparison-"+t.id,null),e.on("focus.comparison-"+t.id,null)}t.on("mousemove.comparison",null).on("mouseout.comparison",null),t.selectAll("canvas").each(n).remove(),t.selectAll(".title,.value").remove()},d.height=function(e){return arguments.length?(i=+e,d):i},d.primary=function(e){return arguments.length?(o=e,d):o},d.secondary=function(e){return arguments.length?(u=e,d):u},d.scale=function(e){return arguments.length?(s=e,d):s},d.extent=function(e){return arguments.length?(a=e,d):a},d.title=function(e){return arguments.length?(f=e,d):f},d.formatPrimary=function(e){return arguments.length?(l=e,d):l},d.formatChange=function(e){return arguments.length?(c=e,d):c},d.colors=function(e){return arguments.length?(h=e,d):h},d.strokeWidth=function(e){return arguments.length?(p=e,d):p},d};var y=d3.format(".2s"),b=d3.format("+.0%");o.axis=function(){function s(o){var u=++n,a,f=o.append("svg").datum({id:u}).attr("width",e.size()).attr("height",Math.max(28,-s.tickSize())).append("g").attr("transform","translate(0,"+(r.orient()==="top"?27:4)+")").call(r);e.on("change.axis-"+u,function(){f.call(r),a||(a=d3.select(f.node().appendChild(f.selectAll("text").node().cloneNode(!0))).style("display","none").text(null))}),e.on("focus.axis-"+u,function(e){if(a)if(e==null)a.style("display","none"),f.selectAll("text").style("fill-opacity",null);else{a.style("display",null).attr("x",e).text(i(t.invert(e)));var n=a.node().getComputedTextLength()+6;f.selectAll("text").style("fill-opacity",function(r){return Math.abs(t(r)-e)<n?0:1})}})}var e=this,t=e.scale,r=d3.svg.axis().scale(t),i=d3.scale.linear().tickFormat(10);return s.remove=function(t){function n(t){e.on("change.axis-"+t.id,null),e.on("focus.axis-"+t.id,null)}t.selectAll("svg").each(n).remove()},s.focusFormat=function(e){return arguments.length?(i=e==null?formatDefault:e,s):i==formatDefault?null:e},d3.rebind(s,r,"orient","ticks","tickSubdivide","tickSize","tickPadding","tickFormat")},o.rule=function(){function i(r){var i=++n,s=r.append("div").datum({id:i}).attr("class","line").call(S);r.each(function(i,s){function f(t,n){var i=[];for(var s=0,o=e.size();s<o;++s)a.valueAt(s)&&i.push(s);var u=r.selectAll(".metric").data(i);u.exit().remove(),u.enter().append("div").attr("class","metric line").call(S),u.style("left",x)}var o=this,u=++n,a=typeof t=="function"?t.call(o,i,s):t;if(!a)return;e.on("change.rule-"+u,f),a.on("change.rule-"+u,f)}),e.on("focus.rule-"+i,function(e){s.datum(e).style("display",e==null?"none":null).style("left",e==null?null:x)})}var e=this,t=r;return i.remove=function(t){function n(t){e.on("focus.rule-"+t.id,null)}t.selectAll(".line").each(n).remove()},i.metric=function(e){return arguments.length?(t=e,i):t},i}})(this);